<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>palimpsest — Fast serializable C++ dictionaries: palimpsest — Fast serializable C++ dictionaries</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">palimpsest — Fast serializable C++ dictionaries
   &#160;<span id="projectnumber">v2.2.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">palimpsest — Fast serializable C++ dictionaries </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> <a href="https://github.com/upkie/palimpsest/actions"><img src="https://img.shields.io/github/actions/workflow/status/upkie/palimpsest/bazel.yml?branch=main" alt="Build" class="inline"/></a> <a href="https://coveralls.io/github/upkie/palimpsest?branch=main"><img src="https://coveralls.io/repos/github/upkie/palimpsest/badge.svg?branch=main" alt="Coverage" style="pointer-events: none;" class="inline"/></a> <a href="https://upkie.github.io/palimpsest/"><img src="https://img.shields.io/badge/docs-online-brightgreen?style=flat" alt="Documentation" class="inline"/></a> <img src="https://img.shields.io/badge/C++-17/20-blue.svg?style=flat" alt="C++ version" style="pointer-events: none;" class="inline"/> <a href="https://github.com/upkie/palimpsest/releases"><img src="https://img.shields.io/github/v/release/upkie/palimpsest.svg?sort=semver" alt="Release" style="pointer-events: none;" class="inline"/></a></p>
<p><em>palimpsest</em> implements a <code>Dictionary</code> type for C++ meant for fast value updates and serialization. It is called <a href="https://en.wiktionary.org/wiki/palimpsest#Noun">palimpsest</a> because dictionaries are designed for frequent rewritings (values change fast) on the same support (keys change slow).</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Example</h1>
<p>Let's fill a dictionary and print it to the standard output:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="Dictionary_8h.html">palimpsest/Dictionary.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using</span> <a class="code" href="classpalimpsest_1_1Dictionary.html">palimpsest::Dictionary</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">  Dictionary world;</div>
<div class="line">  world(<span class="stringliteral">&quot;name&quot;</span>) = <span class="stringliteral">&quot;example&quot;</span>;</div>
<div class="line">  world(<span class="stringliteral">&quot;temperature&quot;</span>) = 28.0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span>&amp; bodies = world(<span class="stringliteral">&quot;bodies&quot;</span>);</div>
<div class="line">  bodies(<span class="stringliteral">&quot;plane&quot;</span>)(<span class="stringliteral">&quot;orientation&quot;</span>) = Eigen::Quaterniond{0.9239, 0.3827, 0., 0.};</div>
<div class="line">  bodies(<span class="stringliteral">&quot;plane&quot;</span>)(<span class="stringliteral">&quot;position&quot;</span>) = Eigen::Vector3d{0.0, 0.0, 100.0};</div>
<div class="line">  bodies(<span class="stringliteral">&quot;truck&quot;</span>)(<span class="stringliteral">&quot;orientation&quot;</span>) = Eigen::Quaterniond::Identity();</div>
<div class="line">  bodies(<span class="stringliteral">&quot;truck&quot;</span>)(<span class="stringliteral">&quot;position&quot;</span>) = Eigen::Vector3d{42.0, 0.0, 0.0};</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; world &lt;&lt; std::endl;</div>
<div class="line">  <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="ttc" id="aDictionary_8h_html"><div class="ttname"><a href="Dictionary_8h.html">Dictionary.h</a></div></div>
<div class="ttc" id="aclasspalimpsest_1_1Dictionary_html"><div class="ttname"><a href="classpalimpsest_1_1Dictionary.html">palimpsest::Dictionary</a></div><div class="ttdoc">Dictionary of values and sub-dictionaries.</div><div class="ttdef"><b>Definition:</b> <a href="Dictionary_8h_source.html#l00097">Dictionary.h:97</a></div></div>
</div><!-- fragment --><p>This code outputs:</p>
<div class="fragment"><div class="line">{&quot;bodies&quot;: {&quot;truck&quot;: {&quot;position&quot;: [42, 0.5, 0], &quot;orientation&quot;: [1, 0, 0, 0]},</div>
<div class="line">&quot;plane&quot;: {&quot;position&quot;: [0.1, 0, 100], &quot;orientation&quot;: [0.9239, 0.3827, 0, 0]}},</div>
<div class="line">&quot;temperature&quot;: 28, &quot;name&quot;: &quot;example&quot;}</div>
</div><!-- fragment --><p>We can serialize the dictionary to file:</p>
<div class="fragment"><div class="line">world.write(<span class="stringliteral">&quot;world.mpack&quot;</span>);</div>
</div><!-- fragment --><p>And deserialize it likewise:</p>
<div class="fragment"><div class="line">Dictionary world_bis;</div>
<div class="line">world_bis.read(<span class="stringliteral">&quot;world.mpack&quot;</span>);</div>
<div class="line">std::cout &lt;&lt; world_bis &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>Dictionaries can also be <a href="#serialization-to-bytes">serialized to bytes</a> for transmission over TCP, memory-mapped files, telegraph lines, etc.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Link with Python dictionaries</h1>
<p><em>palimpsest</em> will feel familiar if you are used to Python dictionaries, as its API is a subset of Python's <code>dict</code>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Python <code>dict</code>   </th><th class="markdownTableHeadNone">In <em>palimpsest</em>?    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>clear</code>   </td><td class="markdownTableBodyNone">✔️    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>copy</code>   </td><td class="markdownTableBodyNone">✖️    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>fromkeys</code>   </td><td class="markdownTableBodyNone">✖️    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>get</code>   </td><td class="markdownTableBodyNone">✔️    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>items</code>   </td><td class="markdownTableBodyNone">✖️    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>keys</code>   </td><td class="markdownTableBodyNone">✔️    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>pop</code>   </td><td class="markdownTableBodyNone">✖️    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>popitem</code>   </td><td class="markdownTableBodyNone">✖️    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>setdefault</code>   </td><td class="markdownTableBodyNone">✖️    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>update</code>   </td><td class="markdownTableBodyNone">✔️    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>values</code>   </td><td class="markdownTableBodyNone">✔️   </td></tr>
</table>
<p>Implementing one of the functions marked with a ✖️ is a great way to <a class="el" href="md_CONTRIBUTING.html">contribute</a> to this project.</p>
<p>Code in the <a href="https://github.com/upkie/palimpsest/tree/main/examples">examples/</a> directory shows how to save and load dictionaries to and from C++ and Python.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Features and non-features</h1>
<p>All design decisions have their pros and cons. Take a look at the features and non-features below to decide if it is also a fit for <em>your</em> use case.</p>
<p>The two main assumptions in <em>palimpsest</em> dictionaries are that:</p>
<ul>
<li><b>Keys</b> are strings.</li>
<li><b>Values</b> hold either a sub-dictionary or a type that can be unambiguously serialized.</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Features</h2>
<ul>
<li>Prioritizes speed over user-friendliness</li>
<li>Returns references to any stored value or sub-dictionaries</li>
<li>Built for fast inter-process communication with <a href="https://www.python.org/">Python</a></li>
<li>Built-in support for <a href="https://eigen.tuxfamily.org/">Eigen</a></li>
<li>Serialize to and deserialize from <a href="https://msgpack.org/">MessagePack</a></li>
<li>Print dictionaries to standard output as <a href="https://www.json.org/json-en.html">JSON</a></li>
<li><a href="#adding-custom-types">Extensible</a> to custom types, as long as they deserialize unambiguously</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Non-features</h2>
<ul>
<li>Prioritizes speed over user-friendliness</li>
<li>Array values are mostly limited to Eigen tensors (matrix, quaternion, vector)</li>
<li>Copy constructors are disabled</li>
<li>Custom types need to deserialize unambiguously</li>
<li>Shallow and deep copies are not implemented (<a class="el" href="md_CONTRIBUTING.html">PRs welcome</a>)</li>
</ul>
<p>Check out the existing <a href="https://github.com/upkie/palimpsest#alternatives">alternatives</a> if any of these choices is a no-go for you.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Installation</h1>
<h2><a class="anchor" id="autotoc_md7"></a>
Bazel</h2>
<p>Add the following to your <code>WORKSPACE</code> file:</p>
<div class="fragment"><div class="line">load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)</div>
<div class="line"> </div>
<div class="line">http_archive(</div>
<div class="line">    name = &quot;palimpsest&quot;,</div>
<div class="line">    sha256 = &quot;f3f7c004197ce808f44a3698928d48a317f9b6f11b29397d0b8c0c6f2a7d0c1c&quot;,</div>
<div class="line">    strip_prefix = &quot;palimpsest-1.1.0&quot;,</div>
<div class="line">    url = &quot;https://github.com/upkie/palimpsest/archive/refs/tags/v1.1.0.tar.gz&quot;,</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">load(&quot;@palimpsest//tools/workspace:default.bzl&quot;, add_palimpsest_repositories = &quot;add_default_repositories&quot;)</div>
<div class="line"> </div>
<div class="line"># This adds dependencies such as @fmt and @mpack for building palimpsest targets</div>
<div class="line">add_palimpsest_repositories()</div>
</div><!-- fragment --><p>You can then use the <code>@palimpsest</code> dependency in your C++ targets.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
CMake</h2>
<p>Make sure Eigen, fmt and spdlog are installed system-wise, for instance on Debian-based distributions:</p>
<div class="fragment"><div class="line">sudo apt install libeigen3-dev libfmt-dev libspdlog-dev</div>
</div><!-- fragment --><p>Then follow the standard CMake procedure:</p>
<div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake .. -DCMAKE_BUILD_TYPE=Release</div>
<div class="line">make -j4</div>
<div class="line">make install</div>
</div><!-- fragment --><p>Note that by default <a href="https://github.com/ludocode/mpack">MPack</a> will be built and installed from the <a href="https://github.com/upkie/palimpsest/tree/main/third_party"><code>third_party</code></a> folder. Set <code>-DBUILD_MPACK=OFF</code> if you already have MPack 1.1 or later installed on your system.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Usage</h1>
<h2><a class="anchor" id="autotoc_md10"></a>
Serialization to bytes</h2>
<p>Dictionaries can be serialized (<code><a class="el" href="classpalimpsest_1_1Dictionary.html#ab7406701cb0e664b6415035c8bdf7f15" title="Serialize to raw MessagePack data.">palimpsest::Dictionary::serialize</a></code>) to vectors of bytes:</p>
<div class="fragment"><div class="line">Dictionary world;</div>
<div class="line">std::vector&lt;char&gt; buffer;</div>
<div class="line"><span class="keywordtype">size_t</span> size = world.serialize(buffer);</div>
</div><!-- fragment --><p>The function resizes the buffer automatically if needed, and returns the number of bytes of the serialized message.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Deserialization from bytes</h2>
<p>Dictionaries can be updated (<code><a class="el" href="classpalimpsest_1_1Dictionary.html#a1b5bb02bcf813b05aef280f47b25ce80" title="Update dictionary from raw MessagePack data.">palimpsest::Dictionary::update</a></code>) from byte vectors:</p>
<div class="fragment"><div class="line">Dictionary foo;</div>
<div class="line">foo(<span class="stringliteral">&quot;bar&quot;</span>) = 1;</div>
<div class="line">foo(<span class="stringliteral">&quot;foo&quot;</span>) = 2;</div>
<div class="line"> </div>
<div class="line">Dictionary bar;</div>
<div class="line">bar(<span class="stringliteral">&quot;bar&quot;</span>) = 3;</div>
<div class="line">std::vector&lt;char&gt; buffer;</div>
<div class="line"><span class="keywordtype">size_t</span> size = bar.serialize(buffer);</div>
<div class="line"> </div>
<div class="line">foo.update(buffer.data(), size);  <span class="comment">// OK, now foo(&quot;bar&quot;) == 3</span></div>
</div><!-- fragment --><p>Keys in the update stream that are not already in the dictionary are ignored:</p>
<div class="fragment"><div class="line">bar(<span class="stringliteral">&quot;new&quot;</span>) = 4;</div>
<div class="line"><span class="keywordtype">size_t</span> size = bar.serialize(buffer);</div>
<div class="line">foo.update(buffer.data(), size);  <span class="comment">// no effect</span></div>
</div><!-- fragment --><p>Updates therefore behave complementarily to extensions: updating <code>{"a": 12}</code> with <code>{"a": 42, "b": 1}</code> results in <code>{"a": 42}</code> rather than <code>{"a": 12, "b": 1}</code>.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Adding custom types</h2>
<p>Adding a new custom type boils down to the following steps:</p>
<ul>
<li>Add implicit type conversions to <code><a class="el" href="Dictionary_8h.html">Dictionary.h</a></code></li>
<li>Add a read function specialization to <code>mpack/read.h</code></li>
<li>Add a write function specialization to <code>mpack/Writer.h</code></li>
<li>Add a write function specialization to <code>mpack/write.h</code></li>
<li>Add a write function specialization to <code>json/write.h</code></li>
</ul>
<p>Take a look at the existing types in these files and in unit tests for inspiration.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Q and A</h1>
<blockquote class="doxtable">
<p>Why isn't <em>palimpsest</em> also distributed as a header-only library? </p>
</blockquote>
<p>The main blocker is that we set a custom flush function <code>mpack_std_vector_writer_flush</code> to our internal MPack writers. The <a href="https://ludocode.github.io/mpack/group__writer.html">MPack Write API</a> requires a function pointer for that, and we define that function in <a href="src/mpack/Writer.cpp"><code>Writer.cpp</code></a>. Open a PR if you have ideas to go around that!</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Alternatives</h1>
<ul>
<li><a href="https://github.com/jrl-umi3218/mc_rtc/blob/master/include/mc_rtc/Configuration.h"><code>mc_rtc::Configuration</code></a> - similar API to palimpsest, based on RapidJSON (see below).</li>
<li><a href="https://github.com/jrl-umi3218/mc_rtc/blob/master/include/mc_rtc/DataStore.h"><code>mc_rtc::DataStore</code></a> - can hold more general value types, like lambda functions, but does not serialize.</li>
<li><a href="https://github.com/mjbots/mjlib/tree/master/mjlib/telemetry#readme"><code>mjlib::telemetry</code></a> - if your use case is more specifically telemetry in robotics or embedded systems.</li>
<li><a href="https://github.com/nlohmann/json">JSON for Modern C++</a> - most user-friendly library of this list, serializes to MessagePack and other binary formats, but not designed for speed.</li>
<li><a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> - good fit if you have a fixed schema (keys don't change at all) that you want to serialize to and from.</li>
<li><a href="https://github.com/Tencent/rapidjson/">RapidJSON</a> - low memory footprint, can serialize to MessagePack using other <a href="https://github.com/Tencent/rapidjson/wiki/Related-Projects">related projects</a>, but has linear lookup complexity as it stores dictionaries <a href="https://github.com/Tencent/rapidjson/issues/102">as lists of key-value pairs</a>.</li>
<li><a href="https://github.com/simdjson/simdjson/">simdjson</a> - uses SIMD instructions and microparallel algorithms to parse JSON (reportedly 4x faster than RapidJSON and 25x faster than JSON for Modern C++). </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
